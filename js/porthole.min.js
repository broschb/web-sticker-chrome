(function(){var b=!1,d=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.PortholeClass=function(){};PortholeClass.extend=function(a){function c(){!b&&this.init&&this.init.apply(this,arguments)}var f=this.prototype;b=!0;var g=new this;b=!1;for(var e in a)g[e]="function"==typeof a[e]&&"function"==typeof f[e]&&d.test(a[e])?function(a,c){return function(){var d=this._super;this._super=f[a];var b=c.apply(this,arguments);this._super=d;return b}}(e,a[e]):a[e];c.prototype=g;c.prototype.constructor=c;c.extend=
arguments.callee;return c}})();
(function(b){var d={debug:!1,trace:function(a){this.debug&&void 0!==b.console&&b.console.log("Porthole: "+a)},error:function(a){void 0!==b.console&&b.console.error("Porthole: "+a)},WindowProxy:function(){}};d.WindowProxy.prototype={post:function(){},addEventListener:function(){},removeEventListener:function(){}};d.WindowProxyBase=PortholeClass.extend({init:function(a){void 0===a&&(a="");this.targetWindowName=a;this.origin=b.location.protocol+"//"+b.location.host;this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},
getOrigin:function(){return this.origin},getTargetWindow:function(){return d.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(a,c){void 0===c&&(c="*");this.dispatchMessage({data:a,sourceOrigin:this.getOrigin(),targetOrigin:c,sourceWindowName:b.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(a){this.eventListeners.push(a);return a},removeEventListener:function(a){var c;try{c=this.eventListeners.indexOf(a),this.eventListeners.splice(c,1)}catch(d){this.eventListeners=
[]}},dispatchEvent:function(a){var c;for(c=0;c<this.eventListeners.length;c++)try{this.eventListeners[c](a)}catch(d){}}});d.WindowProxyLegacy=d.WindowProxyBase.extend({init:function(a,c){this._super(c);null!==a?(this.proxyIFrameName=this.targetWindowName+"ProxyIFrame",this.proxyIFrameLocation=a,this.proxyIFrameElement=this.createIFrameProxy()):(this.proxyIFrameElement=null,d.trace("proxyIFrameUrl is null, window will be a receiver only"),this.post=function(){throw Error("Receiver only window");})},
createIFrameProxy:function(){var a=document.createElement("iframe");a.setAttribute("id",this.proxyIFrameName);a.setAttribute("name",this.proxyIFrameName);a.setAttribute("src",this.proxyIFrameLocation);a.setAttribute("frameBorder","1");a.setAttribute("scrolling","auto");a.setAttribute("width",30);a.setAttribute("height",30);a.setAttribute("style","position: absolute; left: -100px; top:0px;");a.style.setAttribute&&a.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;");document.body.appendChild(a);
return a},dispatchMessage:function(a){var c=b.encodeURIComponent;this.proxyIFrameElement&&(a=this.proxyIFrameLocation+"#"+c(d.WindowProxy.serialize(a)),this.proxyIFrameElement.setAttribute("src",a),this.proxyIFrameElement.height=50<this.proxyIFrameElement.height?50:100)}});d.WindowProxyHTML5=d.WindowProxyBase.extend({init:function(a,c){this._super(c);this.eventListenerCallback=null},dispatchMessage:function(a){this.getTargetWindow().postMessage(d.WindowProxy.serialize(a),a.targetOrigin)},addEventListener:function(a){if(0===
this.eventListeners.length){var c=this;b.addEventListener?(this.eventListenerCallback=function(a){c.eventListener(c,a)},b.addEventListener("message",this.eventListenerCallback,!1)):b.attachEvent&&(this.eventListenerCallback=function(){c.eventListener(c,b.event)},b.attachEvent("onmessage",this.eventListenerCallback))}return this._super(a)},removeEventListener:function(a){this._super(a);0===this.eventListeners.length&&(b.removeEventListener?b.removeEventListener("message",this.eventListenerCallback):
b.detachEvent&&("undefined"===typeof b.onmessage&&(b.onmessage=null),b.detachEvent("onmessage",this.eventListenerCallback)),this.eventListenerCallback=null)},eventListener:function(a,c){var b=d.WindowProxy.unserialize(c.data);b&&(""===a.targetWindowName||b.sourceWindowName==a.targetWindowName)&&a.dispatchEvent(new d.MessageEvent(b.data,c.origin,a))}});b.postMessage?(d.trace("Using built-in browser support"),d.WindowProxy=d.WindowProxyHTML5.extend({})):(d.trace("Using legacy browser support"),d.WindowProxy=
d.WindowProxyLegacy.extend({}));d.WindowProxy.serialize=function(a){if(typeof JSON==="undefined")throw Error("Porthole serialization depends on JSON!");return JSON.stringify(a)};d.WindowProxy.unserialize=function(a){if(typeof JSON==="undefined")throw Error("Porthole unserialization dependens on JSON!");try{var c=JSON.parse(a)}catch(b){return false}return c};d.WindowProxy.getTargetWindow=function(a){return a===""?parent:a==="top"||a==="parent"?b[a]:b.frames[a]};d.MessageEvent=function(a,c,b){this.data=
a;this.origin=c;this.source=b};d.WindowProxyDispatcher={forwardMessageEvent:function(){var a;a=b.decodeURIComponent;var c;if(document.location.hash.length>0){a=d.WindowProxy.unserialize(a(document.location.hash.substr(1)));c=d.WindowProxy.getTargetWindow(a.targetWindowName);(c=d.WindowProxyDispatcher.findWindowProxyObjectInWindow(c,a.sourceWindowName))?c.origin===a.targetOrigin||a.targetOrigin==="*"?c.dispatchEvent(new d.MessageEvent(a.data,a.sourceOrigin,c)):d.error("Target origin "+c.origin+" does not match desired target of "+
a.targetOrigin):d.error("Could not find window proxy object on the target window")}},findWindowProxyObjectInWindow:function(a,c){var b;if(a)for(b in a)if(Object.prototype.hasOwnProperty.call(a,b))try{if(a[b]!==null&&typeof a[b]==="object"&&a[b]instanceof a.Porthole.WindowProxy&&a[b].getTargetWindowName()===c)return a[b]}catch(d){}return null},start:function(){b.addEventListener?b.addEventListener("resize",d.WindowProxyDispatcher.forwardMessageEvent,false):b.attachEvent&&b.postMessage!=="undefined"?
b.attachEvent("onresize",d.WindowProxyDispatcher.forwardMessageEvent):document.body.attachEvent?b.attachEvent("onresize",d.WindowProxyDispatcher.forwardMessageEvent):d.error("Cannot attach resize event")}};"undefined"!==typeof b.exports?b.exports.Porthole=d:b.Porthole=d})(this);
